<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="prj">  

    <select id="nextvalId">
        SELECT nextval(#{id}) FROM DUAL;
    </select>

    <select id="selectPrj">
      SELECT prj_id
      FROM project
      WHERE prj_id = #{prj_id}
    </select>

    <select id="selectPrjVersion">
      SELECT *
      FROM project_version
      WHERE prj_id = #{prj_id}
      AND version_number = #{version_number}
    </select>

    <insert id="insertPrj">
      INSERT INTO project
      (
          prj_id
        , prj_name
        , prj_description
        , prj_start_version
      )
      VALUES
      (
          #{prj_id}
        , #{prj_name}
        , #{prj_description}
        , #{prj_start_version}
      )
    </insert>

    <insert id="insertPrjVersion">
      INSERT INTO project_version
      (
          version_id
        , prj_id
        , version_number
      )
      VALUES
      (
          #{version_id}
        , #{prj_id}
        , #{version_number}
      )
    </insert>
    
    <insert id="insertPrjStepCreate">
      INSERT INTO project_step
      (
          step_id
        , prj_id
        , version_number
        , step_number
        , step_status
      ) 
      VALUES
      (
          #{step_id}
        , #{prj_id}
        , #{version_number}
        , #{step_number}
        , #{step_status}
      )
    </insert>

    <insert id="insertPrjHistoryCreate">
      INSERT INTO project_history
      (
          history_id
        , prj_id
        , version_number
        , step_number
        , step_status
        , step_url
        , step_file
        , step_comment
      ) 
      VALUES
      (
          #{history_id}
        , #{prj_id}
        , #{version_number}
        , #{step_number}
        , #{step_status}
        , #{step_url}
        , #{step_file}
        , #{step_comment}
      )
    </insert>

    <insert id="insertPrjFile">
      INSERT INTO project_file
      (
          file_id
        , prj_id
        , version_number
        , file_path
      ) 
      VALUES
      (
          #{file_id}
        , #{prj_id}
        , #{version_number}
        , #{file_path}
      )
    </insert>

    <select id="selectPrjDetail">
      SELECT  a.prj_id                                     AS prjId
            , a.prj_name                                   AS prjName
            , a.prj_description                            AS prjDescription
            , b.user_name                                  AS prjSecUserName
            , a.prj_sec_user                               AS prjSecUserId
            , c.user_name                                  AS prjDevUserName
            , a.prj_dev_user                               AS prjDevUserId
            , e.version_number                             AS versionNumber
            , d.step_number                                AS stepNumber
            , d.step_status                                AS stepStatus
            , d.step_file                                  AS stepFile
      FROM project a
      LEFT JOIN user_info b ON FIND_IN_SET(b.user_id, a.prj_sec_user) > 0
      LEFT JOIN user_info c ON FIND_IN_SET(c.user_id, a.prj_dev_user) > 0
      LEFT JOIN project_step d
      LEFT JOIN project_version e
      WHERE 1=1
      AND a.prj_id = #{prj_id}
    </select>

    <select id="selectPrjList">
      SELECT a.prj_id
           , a.prj_name
           , b.step_number
           , b.step_status
           , b.version_number
           , b.rgst_dtm
           , b.updt_dtm
      FROM project a, project_step b
      WHERE a.prj_id = b.prj_id
      ORDER BY a.rgst_dtm DESC;
    </select>

    <select id="selectPrjStep">
      SELECT step_id             AS stepId
            , prj_id              AS prjId
            , version_number      AS versionNumber
            , step_number         AS stepNumber
            , step_status         AS stepStatus
            , step_url            AS stepUrl
            , step_file           AS stepFile
            , step_comment        AS stepComment
            , step_result_comment AS stepResultComment
            , step_result_file    AS stepResultFile
            , step_result_url     AS stepResultUrl
      FROM  project_step
      WHERE prj_id = #{prj_id}
      AND   version_number = #{version_number}
    </select>

    <insert id="insertPrjSecManager">
      INSERT INTO project_security_manager
      (
          prj_sec_id
        , prj_id
        , version_number
        , sec_id
      )
      VALUES
      (
          #{prj_sec_id}
        , #{prj_id}
        , #{version_number}
        , #{sec_id}
      )
    </insert>

    <insert id="insertPrjDevManager">
      INSERT INTO project_develop_manager
      (
          prj_dev_id
        , prj_id
        , version_number
        , dev_id
      )
      VALUES
      (
          #{prj_dev_id}
        , #{prj_id}
        , #{version_number}
        , #{dev_id}
      )
    </insert>

    <insert id="insertPrjStep">
      INSERT INTO project_step
      (
          step_id
        , prj_id
        , version_number
        , step_number
        , step_status
        , step_result_comment
        , step_result_file
        , step_result_url
      )
      VALUES
      (
          #{step_id}
        , #{prj_id}
        , #{version_number}
        , #{step_number}
        , #{step_status}
        , #{step_result_comment}
        , #{step_result_file}
        , #{step_result_url}
      )
      ON DUPLICATE KEY UPDATE
          step_number         = #{step_number}
        , step_status         = #{step_status}
        , step_result_comment = #{step_result_comment}
        , step_result_file    = #{step_result_file}
        , step_result_url     = #{step_result_url}
      
    </insert>

    <insert id="insertPrjHistory">
      INSERT INTO project_history
      (
          history_id
        , prj_id
        , version_number
        , step_number
        , step_status
        , step_url
        , step_file
        , step_comment
        , step_result_comment
        , step_result_file
        , step_result_url
      ) 
      VALUES
      (
          #{history_id}
        , #{prj_id}
        , #{version_number}
        , #{step_number}
        , #{step_status}
        , #{step_url}
        , #{step_file}
        , #{step_comment}
        , #{step_result_comment}
        , #{step_result_file}
        , #{step_result_url}
      )
    </insert>

</mapper>